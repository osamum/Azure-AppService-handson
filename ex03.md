# 演習 3 : Advanced なアプリケーション設定

[演習 2](ex02.md) では Web サイトを Web サーバーで運用する際に必要となる一般的な設定や操作を App Service で行うための方法について紹介しましたが、この演習 3 では Web アプリケーションを運用するためのより高度な設定を行う以下の方法について紹介します。

 1. [より高度なデプロイ](#%E3%82%BF%E3%82%B9%E3%82%AF-1--%E3%82%88%E3%82%8A%E9%AB%98%E5%BA%A6%E3%81%AA%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4)
    1. [デプロイ スロット](#%E3%82%BF%E3%82%B9%E3%82%AF-11--%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4-%E3%82%B9%E3%83%AD%E3%83%83%E3%83%88)
    2. [GitHub リポジトリを使用した CI/CD](#%E3%82%BF%E3%82%B9%E3%82%AF-12--github-%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F-cicd)
2. [可用性設定](#%E3%82%BF%E3%82%B9%E3%82%AF-2--%E5%8F%AF%E7%94%A8%E6%80%A7%E8%A8%AD%E5%AE%9A)
    1. [スケールアップ](#%E3%82%BF%E3%82%B9%E3%82%AF-21--%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97)
    2. [スケールアウト](#%E3%82%BF%E3%82%B9%E3%82%AF-22--%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AB%E3%82%A2%E3%82%A6%E3%83%88)
    3. [自動スケーリング](#%E3%82%BF%E3%82%B9%E3%82%AF-23--%E8%87%AA%E5%8B%95%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0)
3. [高度なログ監視](#%E3%82%BF%E3%82%B9%E3%82%AF-3--%E9%AB%98%E5%BA%A6%E3%81%AA%E3%83%AD%E3%82%B0%E7%9B%A3%E8%A6%96)
    1. [メトリック アラートの設定](#%E3%82%BF%E3%82%B9%E3%82%AF-31--%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A)
    2. [Log Analytics を使用したログの分析](#%E3%82%BF%E3%82%B9%E3%82%AF-32--log-analytics-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%AE%E5%88%86%E6%9E%90)
    3. [Application Insights 使用したアプリケーションの監視](#%E3%82%BF%E3%82%B9%E3%82%AF-33--application-insights-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%9B%A3%E8%A6%96)

<br>



## タスク 1 : より高度なデプロイ

[演習 1 のタスク 4](ex01.md#%E3%82%BF%E3%82%B9%E3%82%AF-4-appservice-%E3%81%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4) では開発環境のアプリケーションを Visual Studio から直接に新規に作成した App Sevice にデプロイする手順を紹介しました。

しかしこの方法は、実際にユーザーにサービスを提供している稼働中のシステムに対し実運用環境での動作確認もせずに書き換えを行うという手順と同じであり、実際の運用シナリオにおいては望ましくない方法です。またデプロイもアプリケーションの更新があるたびに手動で行う必要があります。

このタスク 1 では、アプリケーションをデプロイする環境と運用環境を別け、かつ、アプリケーションの更新のタイミングと連動する自動更新の仕組みを確認します。



### タスク 1.1 : デプロイ スロット

App Service プランのサービス レベルが Standard、Premium、または Isolated である場合は、デプロイ スロットを使用して、アプリケーションのステージング、テスト、および本番環境を分離できます。

デプロイ スロットを使用すると、運用環境上の Staging 用のスロットを使用してアプリケーションの新しいバージョンのテストを行い、テストが完了したら、トラフィックをデプロイ スロットから本番環境に切り替えるといったシナリオが実現できます。

このハンズオンでは既に演習 2 の[バックアップのリストアの手順](ex02.md#%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%A8%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2)で既にデプロイ スロットが一つ作成されていますが、このタスクでは新規作成の手順を確認するために、新規にデプロイ スロットを作成します。

具体的な手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインします

2. このハンズオンで使用している App Service、`MovieApp-XYZ` を選択し、画面左のメニューから \[**デプロイ スロット**\] を選択します

3. 遷移した画面で上部の \[**+ スロットの追加**\] をクリックし、画面右に表示される \[**スロットの追加**\] ブレードの各項目を以下のように
設定します

    |項目|値|
    |---|---|
    |名前| `staging` |
    |次から設定を複製:| **設定を複製しない** (※) |

    (※) 今回は現在リクエストを処理している運用 (production) 環境から引継がなければならない環境変数などの固有の設定がないため、設定を複製しないで新規に作成します。設定を複製する場合は、この項目を選択し、引継ぎたい設定を選択します。スワップによってスロット間で引き継がれる設定については以下のドキュメントを確認してください。

    * [Azure App Service でステージング環境を設定する - **スワップされる設定**](https://learn.microsoft.com/ja-jp/azure/app-service/deploy-staging-slots?tabs=portal#which-settings-are-swapped)

    \[**追加**\] ボタンをクリックするとデプロイ スロットの作成が開始されます。

    <img src="images/AppService_new_deploySlot.png" width="700px">

4. デプロイ スロットの作成が完了すると、`スロット 'staging' を正常に作成しました` と \[**追加**\] ボタンの上にメッセージが表示されるので、\[**閉じる**\] ボタンをクリックします。

    \[**デプロイ スロット**\] の画面に戻るので、作成したデプロイ スロットがリストされていることを確認します。

ここまでの手順でデプロイ スロットの作成の手順は完了です。

これで[演習 2 のバックアップの取得とリストア](ex02.md#%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%A8%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2)の手順でリストア作業で行ったように \[**スワップ**\] を行うことで運用環境と今回作成したデプロイ スロット `staging` の App Service インスタンスを切り替えることができるようになりました。

しかし、ここまでの手順で作成したデプロイ スロット `staging` にはアプリケーションがデプロイされていないためインスタンスを切り替えると、運用環境のアプリケーションがデプロイされていない状態になってしまいます。

この先の作業は、[タスク 1.2 : GitHub リポジトリを使用した CI/CD](#%E3%82%BF%E3%82%B9%E3%82%AF-12--github-%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F-cicd) の演習でアプリケーションをデプロイした後に、運用環境とステージング環境を切り替える(スワップ)手順を確認します。 

なお、このようにシステムのリリースを、2 つの本運用環境を使って安全に素早く行う手法を「ブルーグリーン デプロイメント」と言います。

また、Azure App Service のデプロイ スロットではブルーグリーン デプロイメントだけでなく、複数のスロットが受信するトラフィック量を調整し、「A/B テスト」に使用することもできます。

<img src="images/AppService_ABTest.png" width="700px">


Azure App Service のデプロイ スロットの作成の詳細については以下の公式ドキュメントをご参照ください。 


* [Azure App Service でステージング環境を設定する](https://learn.microsoft.com/ja-jp/azure/app-service/deploy-staging-slots?tabs=portal#swap-two-slots)

<br>

### タスク 1.2 : GitHub リポジトリを使用した CI/CD

演習用アプリケーションの入手元のリポジトリがある GitHub では [GitHub Actions](https://docs.github.com/ja/actions/learn-github-actions/understanding-github-actions) というタスク自動化の仕組みが提供されています。この GitHub Actions を使用することで、アプリケーションのビルド、テスト、デプロイのパイプラインを自動化することができます。

GitHub Actions を使用する際には、ビルドからデプロイまでの処理を YAML ファイルにワークフローとして記述していく必要がありますが、Azure App Service では GitHub Actions 用のワークフローを自動で作成する機能が提供されており、かつ、GitHub と Azure App Service を連携させることで、GitHub にプッシュされたコードを App Service で感知し、自動でビルドとデプロイを行うパイプラインを作成することもできます。

この演習では GitHub にプッシュされたコードを App Service で感知し、自動でビルドとデプロイを行うパイプラインを作成します。

なお、この演習ではこの前のタスク 1.2 で作成したデプロイ スロット `MovieApp-XYZ-staging` に対して自動デプロイを行い、運用環境とステージング環境を切り替える手順を確認します。

<!--
**準備**

デプロイ センターの設定を行う前に、同画面内で App Service のビルドサービスを指定する際に必要になる **SCM 基本認証の発行資格情報** を有効にします。

具体的には、Azure ポータルでデプロイ スロット `MovieApp-XYZ-staging` を選択し、画面左のメニューから \[**構成**\] を選択し、遷移した画面の \[**全般**\] タブで \[**SCM 基本認証の発行資格情報**\] を **オン** にして保存します。　

<img src="images/AppService_SCM_BasicAuth.png" width="700px">

<br>
-->

App Service の \[デプロイ センター\] メニューで GitHub からの自動デプロイを設定するための具体的な手順は以下のとおりです。

\[**手順**\]

1. Azure ポータルから前のタスク 1.2 で作成したデプロイ スロット、`MovieApp-XYZ-staging` を選択し、画面左のメニューから \[**デプロイ センター**\] を選択します

2. \[**デプロイ センター**\] の画面に遷移するので、同画面のドロップダウンボックス \[**ソース \***\] から \[**GitHub**\] を選択します

3. \[**次のユーザーとしてサイイン :**\] の項目にご自身の GitHub アカウントが表示されているのを確認し、異なる場合は \[**アカウントの変更**\] リンクをクリックして正しいアカウントを指定します

4. 表示された項目を以下のように変更し、画面上部の \[**保存**\] ボタンをクリックします

    |項目|値|
    |---|---|
    |組織| (自身の GitHub アカウント) |
    |リポジトリ| `MvcMovie` |
    |ブランチ| `main` |

5. \[**認証の設定**\] の項目は以下のように設定します

    |項目|値|
    |---|---|
    |認証タイプ\*| \[**ユーザー割り当て ID**\] |
    |ID\*| `(新規作成)` |
    |ブランチ| `main` |

    <img src="images/AppService_DeployCenter_Settings2.png" width="700px">

    画面下部にある \[**ファイルのプレビュー**\] ボタンをクリックすると、GitHub Actions で使用される YAML ファイルのプレビューが表示されます。このファイルは GitHub にプッシュされたコードを App Service にデプロイするためのパイプラインを定義しています。

    <img src="images/Preview_GitHubWorkflow_file.png" width="700px">

    ファイルの内容を確認したら \[**Close**\] ボタンをクリックしてファイルのプレビュー画面を閉じます。

    デプロイセンターの画面に戻るので、画面上部の \[**保存**\] ボタンをクリックして設定を保存保存します。GitHub からの自動デプロイが設定され、同時に GitHub でワークフローが作成されて実行されます。

6. GitHub にログインし、リポジトリ `MvcMovie` を選択し、画面上部の \[**Actions**\] タブを選択し、作成されたワークフローが実行されていることを確認します

    <img src="images/Run_GitHubWorkFlow.png" width="700px">

    これでプロジェクトが GitHub にプッシュされると、App Service によって自動でビルドが行われ、App Service にデプロイされるようになりました。

    ローカルの開発環境で演習用アプリケーションのコードを書き換え、GitHub にプッシュして AppService にデプロイされるか確認します。


6. ローカル環境で Visual Studio を起動し、演習用アプリケーションのプロジェクトを開きます

    せっかくの機会なので、SPA UI で正しく動作していないデータの更新機能を修正します。修正箇所は SPA UI が参照している Web API のコードです。

7. プロジェクト中のファイル Models/Movie.cs を開き、69 行目の以下のコードを以下のようにコメントアウトします

    ```csharp 
    // .SetProperty(m => m.ID, movie.ID)
    ```
    
    <img src="images/VisualStudio_Codecommentout.png" width="700px">

    これで SPA UI でのデータの更新が正しく動作するようになりますが、さらに変更されたことがよくわかるように、SPA UI の画面左上に表示される文字 **SPA Movie** の色を変更します。

8. プロジェクト中のファイル wwwroot/index.html を開き、16 行目の a タグに style 属性を追加し、文字を青色の太字に変更します

    変更前

    ```html
    <a class="navbar-brand" href="/Movies">SPA Movie</a>
    ```

    変更後

    ```html
    <a class="navbar-brand" href="/Movies" style="color:blue;font-weight:bold;">SPA Movie</a>
    ```

9. 変更を保存後、キーボードの \[**F5**\] キーを押下してプロジェクトを実行し、SPA 画面の文字の色が変更されているか、またデータの更新が正しく動作するか確認します

    なお SPA 画面にアクセスするには以下のように URL のドメイン名の後ろに明示的に **index.html**　と指定する必要があります。

    ```
    https://localhost:61260/index.html
    ```

    アプリケーションの正常動作が確認できたら、変更したコードを GitHub にプッシュしますが、その前に **appsetting.json** ファイルに記述されている Azure SQL Database の接続文字列を削除します。このはそのまま GitHub にプッシュすると、GitHub に接続文字列が公開されてしまうためです。

10. プロジェクトのルートフォルダにあるファイル **appsettings.json** を開き、JSON ノード **ConnectionStrings/MovieContext** に記述されている接続文字列をメモ帳などのテキストエディタに控えた後、接続文字列を空にします

    ```json
    "ConnectionStrings": {
        "MovieContext": ""
    },
    ```

    SQL Database に接続するための接続文字列は、デプロイ後に環境変数を使用して設定します。

    すべての作業が完了したらキーボードの \[Ctrl\] + \[S\] キーを押下して変更を保存してください。

11. プロジェクトを GitHub リポジトリにプッシュします。

    Visual Studio からプッシュすることもできますが、ここではコマンド ラインからプッシュする方法を紹介します。

    プロジェクトのルートディレクトリをターミナル画面で開き、以下のコマンドを順番に実行します。

    ```bash
    git add .
    git commit -m "update code"
    git push origin main
    ``` 

    ローカル環境の作業は以上で終了です。
    
12. コードを変更したアプリケーションがデプロイ スロット `MovieApp-XYZ-staging` にデプロイされた確認します

    Azure ポータルでデプロイ スロット `MovieApp-XYZ-staging` を選択し、画面左のメニューから \[**デプロイ センター**\] を選択します

13. 遷移した画面で \[**ログ**\] タブを選択し、ログが追加されていることを確認します

     <img src="images/AppService_deployCenter_log.png" width="700px">

14. アプリケーションのデプロイが確認できたので、環境変数に Azure SQL Database の接続文字列を設定します

    画面左のメニューから \[**構成**\] を選択し、遷移した画面で \[**+ 新しいアプリケーション設定**\] ボタンをクリックします

15. 画面右に表示される \[**アプリケーション設定の追加/編集**\] ブレードの各項目を以下のように設定します

    |項目|値|
    |---|---|
    |名前| `ConnectionStrings:MvcMovieContext` |
    |値| (前の手順でメモした接続文字列) |
    |デプロイ スロットの設定| チェックしない |

    \[**OK**\] ボタンをクリックすると環境変数の設定が完了します。

16. アプリケーションが正しく動作するか確認します。

    画面左のメニューから \[**概要**\] をクリックし、遷移した画面の \[**既定のドメイン**\] に表示されていドメイン名のリンクをクリックしてアプリケーションの画面が表示されるか確認します。

    念のために Web ブラウザーのアドレスバーの URL に明示的に **index.html** を指定してアクセスし、SPA 画面に加えた変更が反映されているか確認します。

    ```
    https://(既定のドメイン)/index.html

    ```

    デプロイ スロットの `MovieApp-XYZ-staging` にアプリケーションがデプロイされていることが確認できたので、運用環境とステージング環境を切り替えます。

17. 画面左のメニューから \[**デプロイ スロット**\] を選択し、遷移した画面上部の \[**スワップ**\] ボタンをクリックします

    画面右に \[**スワップ**\] ブレードが表示されるので、各項目が以下の通りであることを確認し、\[**スワップ**\] ボタンをクリックします

    |項目|値|
    |---|---|
    |ソース| `MovieApp-XYZ-staging` |
    |ターゲット| `MovieApp-XYZ` (運用) |
    |プレビューでスワップを実行| チェックしない |

    <img src="images/AppService_DeploySlot_Swap.png" width="700px">

    スワップが完了した通知が表示されるので、\[**閉じる**\] ボタンをクリックします。

    これで運用環境の `MovieApp-XYZ` とステージング環境の `MovieApp-XYZ-staging` が切り替っているはずなので確認します。

18. アプリケーションの運用 (Production) 環境である **MovieApp-XYZ** の \[**概要**\] 画面から \[**既定のドメイン**\] のリンクをクリックし、アプリケーションの画面が正常に表示されることを確認します。

    次に、ドメイン名の後ろに **index.html** を指定してアクセスし、SPA 画面に加えた変更が反映されているか確認してください。

    ```
    https://(既定のドメイン)/index.html

    ```

ここまでの手順で App Service と GitHub リポジトリを使用した CI/CD の手順は完了です。

この手順では、使用されるランタイムの関係で GitHub Actions ではなく App Service のビルドサービスを使用してビルドとデプロイを行いましたが、GitHub Actions の yaml を手動で書き換えることで任意のランタイムでのビルドを行い App Servoce にデプロイを行うこともできます。

GitHub Actions を使用した App Service をはじめとした Azure の各種サービスへのデプロイの詳細について GitHud ドキュメントに詳しく記載されていますので、はじめて使用される方はまず最初に以下のクイックスタートを実施し、

* [GitHub Actions のクイックスタート](https://docs.github.com/ja/actions/quickstart)

その後、アプリケーションのランタイムに応じて以下のドキュメントを参照してください。

* [Azure App Service への **.NET** のデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-net-to-azure-app-service)

* [Azure App Service への **Node.js** のデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-nodejs-to-azure-app-service)

* [Azure App Service への **Python** のデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-python-to-azure-app-service)

* [Azure App Service への **Java** のデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-java-to-azure-app-service)

* [Azure App Service への **PHP** のデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-php-to-azure-app-service)

* [Azure App Service に **Docker** をデプロイする](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-docker-to-azure-app-service)

* [Azure **Static Web Apps** のデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-to-azure-static-web-app)

* [Azure **Kubernetes Service** へのデプロイ](https://docs.github.com/ja/actions/deployment/deploying-to-your-cloud-provider/deploying-to-azure/deploying-to-azure-kubernetes-service)


> 【メモ】演習では手順を簡単にするために Azure SQL Database の環境変数に格納していましたが、この方法はセキュリティ的にはベストではありません。
>  データベースや他のサービスへの接続文字列は暗号化が行われる Azure App Service の \[構成\] メニューにある \[接続文字列\] 、または Azure Key Vault に格納して使用することをお勧めします。
> 詳細は以下の公式ドキュメントをご参照ください。

> * [**チュートリアル: Key Vault を使って .NET App Service からの Cognitive Service 接続をセキュリティで保護する**](https://learn.microsoft.com/ja-jp/Azure/app-service/tutorial-connect-msi-key-vault)
> * [**Azure App Service と Azure Functions でアプリ設定として Key Vault 参照を使用する**](https://learn.microsoft.com/ja-jp/azure/app-service/app-service-key-vault-references?tabs=azure-cli)

<br>




## タスク 2 : 可用性設定

システムが実際に稼働を開始すると、時間の経過とともに利用者が増えていき当初に見積った数よりもリクエスト数が増えてしまったり、特定の時間帯や期間にだけアクセスが集中して負荷がサーバーの処理能力を超えてしまうことがあります。このような場合、サーバーの性能を向上させるために、サーバーのスケールアップやスケールアウトを行う必要があります。

Azure App Service ではオンプレミス上のサーバーのようなハードウェアの調達やセットアップの必要はなく、Azure ポータルや CLI ツールを使用し短い時間でスケールアップやスケールアウトの環境を構築することができます。

また、Azure App Service では、スケジュールによるスケールアウトはもちろんのこと、負荷に応じて自動的にスケールアウトする自動スケーリングの設定も可能です。

このタスクでは、Azure App Service でのスケールアップ、スケールアウト、自動スケーリングの設定方法について確認します。

<br>


### タスク 2.1 : スケールアップ

サーバーのスケールアップとは、文字通りサーバーの処理能力（スケール）を垂直方向に向上させる方法です。具体的には CPU、メモリ、ディスク領域を増やしたり、専用の仮想マシン (VM)、カスタム ドメインと証明書、ステージング スロット、自動スケールのような拡張機能を追加したりします。

Azure App Service では、サーバーのスケールアップは App Service プランのサービス レベルを変更することで行います。App Service のプランの変更では仮想 CPU(vCPU)、[Azure コンピューティング ユニット(ACU)](https://learn.microsoft.com/ja-jp/azure/virtual-machines/acu) の数、メモリとストレージのサイズ、スケール可能な数、SLA を変更できます。

App Service をスケールアップする方法は、Azure ポータル、Azure CLI、Azure PowerShell、REST API、または Azure Resource Manager テンプレートを使用して行うことができます。

このタスクの演習では、Azure ポータルを使用したスケールアップの手順を確認しますが、メニューからプランを選択するだけなので、実際に操作は行わず UI を確認するだけで終了とします。

具体的な手順については、以下の公式ドキュメントの内容に従い作業を行ってください。

* [**Azure App Service でアプリをスケールアップする - 価格レベルのスケールアップ**](https://learn.microsoft.com/ja-jp/azure/app-service/manage-scale-up#scale-up-your-pricing-tier)

<br>



### タスク 2.2 : スケールアウト

スケールアップがサーバーの CPU やメモリといったものを増強して性能を垂直方向に向上させる方法であるのに対し、スケールアウトはサーバー単体の能力はそのままに、処理を複数台のサーバーに分散し処理能力（スケール）を水平方向に向上させる方法です。

Azure App Service では、スケールアウトは App Service プランのインスタンス数を増やすことで行います。App Service プランのインスタンス数を増やすことで、アプリケーションの負荷が増えたときに、負荷を分散することができます。

App Service をスケールアウトする方法は、スケールアップ同様、Azure ポータル、Azure CLI、Azure PowerShell、REST API、または Azure Resource Manager テンプレートを使用して行うことができます。

このタスクの演習では、Azure ポータルを使用した手動スケールアウトの手順を確認します。

Azure App Service で、Azure ポータルから手動スケールアップを行う手順は以下のとおりです。


1. [Azure ポータル](https://portal.azure.com/)にログインし、演習で使用している App Service、`MovieApp-XYZ` を選択します

2. 画面左のメニューから \[**スケール アウト (App Service プラン)**\] を選択します

3. 遷移した画面で \[Scale out method (スケールアウト方法)\] で \[**Manual**(手動)\] を選択し、\[**Instance count** (インスタンス数)\] スライド コントロールで任意の数を選択し、\[**Save**\] ボタンをクリックすることでスケールアウト用のインスタンス数を変更できます 

    <img src="images/AppServoce_ScaleUp_manual.png" width="1000px">

4. 画面左のメニューバーから \[**App Service プラン**\] をクリックし、遷移した画面で \[**Instance count**\] 選択すると、前の手順で指定した数にインスタンス数が変更されていることが確認できます 

    <img src="images/AppService_Scaleout_count.png" width="700px">

    これで App Service の手動スケールアウトの手順は完了です。

この方法を使用することで任意のタイミングでスケール アウトを行うことができます。

<br>

### タスク 2.3 : 自動スケーリング

タスク 2.2 では App Service の手動スケーリングの手順を紹介しましたが、負荷が増えたときに自動的にインスタンス数を増やす自動スケーリングの設定も可能です。

自動スケーリングを使用すると、負荷が増えたときにインスタンス数を増やし、負荷が減ったときにインスタンス数を減らすことができます。これにより、負荷に応じてインスタンス数を自動的に増減させることができます。

自動スケーリングの設定は、Azure ポータル、Azure CLI、Azure PowerShell、REST API、または Azure Resource Manager テンプレートを使用して行うことができます。

このタスクの演習では、Azure ポータルを使用した自動スケーリングの手順を実施します。具体的な手順については、以下の公式ドキュメントの内容に従い作業を行いますが、


具体的な設定手順は以下のとおりです。

1. [Azure ポータル](https://portal.azure.com/)のホーム画面、左上にあるハンバーガーメニューをクリックし、表示されたメニューから \[**モニター**\] を選択します

    <img src="images/Menu_Azure_Monitor.png" width="500px">

2. \[**モニター**\] 画面に遷移するので画面左のメニューから \[**自動スケーリング**\] を選択します。

    自動スケーリングが適用できるすべてのリソースが表示されるので、演習で使用している App Service、`MovieApp-XYZ` の App Service プランの名前を選択します


    <img src="images/AppService_AutoScaling_Choseplan.png" width="700px">

3. \[**自動スケーリング設定**\] の画面に遷移するので、画面内の \[**カスタム自動スケーリング**\] (図中 ①) をクリックし、表示された \[**既定** \*  自動生成された既定のスケール条件\] 内の項目 \[スケールモード\] でオプション ボタン \[**メトリックに基づいてスケーリングする**\] (図中 ➁)を選択し、さらに \[ルール\] の説明文中のリンク <u>**規則を追加する**</u>(図中 ➁)をクリックします。

    <img src="images/AotoScale_Settings.png" width="1000px">

4. 画面右に \[**スケール ルール**\] ブレードが表示されます

    このブレードではスケール アウトする条件を設定しますが、この演習ではなるべく早くスケールアウトの動作を確認したいので、CPU の使用率が 20% を超えたらスケールアウトするよう、ブレード内の項目 [**スケール操作をトリガーするメトリックのしきい値** \*] を `20` に変更します。なお、それ以外の項目はの設定は全て既定のままです。
  
    <img src="images/Scaleout_rule.png" width="500px">

    設定が完了したら \[追加\] ボタンをクリックします。

5. \[**自動スケーリング設定**\] の画面に戻るので画面下部の \[**インスタンスの制限**\] で \[**最大値 \***\] の値を `3` に変更します。

    <img src="images/AutoScale_instance_maxValue.png">

    画面右上の \[**保存**\] ボタンをクリックします。

    
ここまでの手順で自動スケーリングの設定は完了です。

なお、今回の手順では CPU の使用率が上がった際にインスタンスを増やす設定しか行っていないため、一度スケールアウトが発生すると、CPU の使用率が下がってもインスタンス数は減らないままになってしまいます。

このような場合、インスタンス数を減らす(スケールイン)ための設定を行う必要がありますが、この演習では時間の都合上割愛しています。

スケールインの設定手順については、以下のドキュメントに詳しい手順が載っていますのでぜひご参照ください。

* [**Azure での自動スケールの使用 - 最初の自動スケーリング設定を作成する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/autoscale/autoscale-get-started?toc=%2Fazure%2Fapp-service%2Ftoc.json#create-your-first-autoscale-setting)


次の手順では Azure Load Testing を使用して負荷をかけ、自動スケーリングが正しく動作するか確認します。


<br>

**■ スケーリング確認の前の準備**

Azure Load Testing を使用して負荷をかける対象となる Web アプリケーション MovieApp-XYZ には [演習 2 のタスク 6](ex02.md#%E3%82%BF%E3%82%B9%E3%82%AF-6--%E8%AA%8D%E8%A8%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6) で App Service の自動認証が設定されており、認証されていないユーザーはアプリケーションの画面にアクセスできないようになっているためこのままでは Azure Load Testing の[クイックテスト](https://learn.microsoft.com/ja-jp/azure/load-testing/quickstart-create-and-run-load-test?tabs=virtual-users#create-a-load-test)で負荷をかけることができません。

次の手順を実施する前に App Service の自動認証を無効にします。

具体的な手順は以下のとおりです。

1. [Azure ポータル](https://portal.azure.com/)で、演習で使用している App Service、`MovieApp-XYZ` を選択します

2. 画面左のメニューから \[**認証**\] を選択します

3. \[**認証の設定**\] 画面に遷移し、項目 \[**ID プロバイダー**\] に [演習 2 のタスク 6](ex02.md#%E3%82%BF%E3%82%B9%E3%82%AF-6--%E8%AA%8D%E8%A8%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6) で設定した ID プロバイダーが表示されているので、その右側にある \[**削除**\] ボタンをクリックします

    <img src="images/AppService_Auth_Delete.png">

ここまでの手順で App Service の自動認証の設定の削除は完了です。

<br>

**■ トラフィックの作成**

Azure Load Testing を使用して Web アプリケーションに対してトラフィックを作成します。

本来であれば、ユーザーが行うユースケースに合わせたシナリオに沿ったシナリオを用意しテストを行うべきですが、今回は手順を簡略化するめに、単純に Web アプリケーションのトップページに対して負荷をかけます。

具体的な手順は以下のとおりです。

1. Azure の検索ボックスから Azure Load Testing を検索してアクセス

2. 「表示する Azure Load Testing のリソース がありません」と表示されるので \[**Azure Load Testing のリソース作成**\] ボタンをクリック

3. [ロード テストのリソース作成] 画面に遷移するので各パラメーターを以下のように設定し、\[**作成**\] ボタンをクリック

    |項目|値|
    |---|---|
    |リソース グループ| `PaaS_Handson` |
    |名前| `MovieApp-XYZ-LoadTest` |
    |場所| `Japan East` |

    <img src="images/LoadTest_Create.png" width="700px">

    \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが有効になったらクリックします

4. リソースが作成されると \[**リソースに移動**\] ボタンが表示されるのでクリックします

5. [ロード テスト] 画面に遷移するので、画面左のメニューから \[**テスト**\] ボタンをクリックし、遷移した画面上部の \[**+ 作成**\] ボタンをクリックし\[**URL ベースのテストを作成する**\] を選択します

    <img src="images/LoadTest_Create_QuickTest.png" width="700px">


6. \[**URL ベースのテストを作成する**\] の画面に遷移するので、項目 \[**テスト URL \***\] に演習用 Web アプリケーションの URL を、\[**テスト期間 (分) \***\] と \[**増加時間 (分) \***\]  を以下のように設定し、他の項目は既定のまま \[**確認及び作成**\] ボタンをクリックして、さらに \[**作成**\] ボタンが表示されたらクリックします。

    | 項目 | 設定値  |
    | ----------- | ------- |
    | テスト URL \* | 演習用 Web アプリケーションの URL  |
    | テスト期間 (分) \* | **2** |
    | 増加時間 (分) \*| **0** |


    <img src="images/LoadTest_QuickTest.png" width="700px">

    「**テストの実行は間もなく開始されます**」のメッセージが表示されるので、しばらく待ちます。

    テストが完了するとテストの結果画面が表示されます。

    <img src="images/LoadTest_Result.png"　width="700px">

    本来のテストであればテストの結果からエラーの発生の有無やスループット等を確認しますが、今回の目的はスケールアウトの動作確認なので、画面上部の \[**テスト実行の削除**\] をクリックして削除しても構いません。

7. スケールアウトが実行されたか確認するために自動スケールのログを確認します

    Azure ポータルのホーム画面で、ハンバーガーメニューから [\[**モニター**\]](https://portal.azure.com/#view/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/~/overview) を選択し、遷移した画面でさらなる左のメニューから [\[**自動スケーリング**\]](https://portal.azure.com/#view/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/~/autoscale) を選択します。

8. 自動スケーリングが適用できるすべてのリソースが表示されるので、演習で使用している App Service、`MovieApp-XYZ` の App Service プランの名前を選択します

    <img src="images/AppService_AutoScaling_Choseplan.png" width="700px">

9. \[**自動スケーリング設定**\] の画面に遷移するので、画面上部の \[**実行履歴**\] タブをクリックして選択します

    <img src="images/AutoScale_Execute_log.png" width="500px">

    同タブの内の \[**観察されたリソースのインスタンス数**\] のグラフの最大値が **3** であることを確認し、さらに \[**Observed Capacity (最大値)**\] の値が **3** であることを確認します。

    <img src="images/AutoScale_Result.png" width="700px">

ここまでの手順で自動スケーリングの動作確認は完了です。

なお、今回の手順では紹介しませんでしたが、\[**自動スケーリングの設定**\] 画面の \[**通知**\] タブでメールアドレスや Web フック用の URL を指定することで、スケーリング イベント発生時に通知を受け取ることもできます。

<img src="images/AutoScale_Notice.png" width="700px">

この手順で紹介したリソースの利用状況をもとにしたルールベースのスケールアウトでなく、日時を指定してスケーリングをスケジュールすることもできます。

具体的な手順については以下のドキュメントをご参照ください。

* [**Azure での自動スケールの使用 - スケジュール化されたスケール条件**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/autoscale/autoscale-get-started?toc=%2Fazure%2Fapp-service%2Ftoc.json#scheduled-scale-conditions)

また App Service で Premium V2 以上のサブスクリプションを使用する場合は、このハンズオンで紹介した手動、ルールベースのスケールアウトに加え、**Azure Monitor のメトリックに基づいた自動スケーリング** も利用できます。仕組みの違い、具体的な設定方法については以下のドキュメントをご参照ください。

* [**Azure App Service での自動スケーリング**](https://learn.microsoft.com/ja-jp/azure/app-service/manage-automatic-scaling?tabs=azure-portal)


<br>

**■ Note : スケールアウト時のアプリケーションのセッション情報の保持について** 

Web コンテンツの基本はページ間にまたがる状態を保持しないステートレスなものであるべきですが、多くの動的ページ アプリケーションではセッション情報として状態(ステート)保持し利用しています。

このセッション情報は多くの場合、アプリケーションをシングルサーバーでホストする場合はサーバーのメモリ上に保持されますが、スケールアウトを行うと複数のインスタンスにリクエストが振り分けされてしまい、次回の接続が前回の状態情報を保持しているサーバーに着信するとは限らないため、セッション情報を保持し、かつリクエストが必要とするセッション情報をマッチングさせる仕組みが必要になります。

Azure App Service では、既定でリクエストが必要とするセッション情報をマッチングさせる仕組み、セッション アフィニティが有効になっているので開発者はサーバーサイドのスケールアウトの動作を意識することなくセッション情報を保持することができます。この分散されている、個々のサーバー上の特定のアプリケーションのインスタンスに各セッションを結び付ける方式は"固定セッション(sticky sessions)" とも呼ばれます。  

セッション アフィニティの設定は App Service の \[**構成**\] メニューの \[**一般設定**\] タブで確認できます。

<img src="images/AppService_Session_Affinity.png" width="700px">

しかし、セッション アフィニティが有効である場合、複数インスタンスに対しリクエストはラウンドロビンされない(均等に振り分けられない)ため、負荷が偏る可能性があります。とくにあらかじめ複数インスタンスでのホストを前提としている場合は負荷が各インスタンスに対し均等でないことについて熟考する必要があります。

App Service の複数インスタンスに対し均等に負荷を振り分けるにはセッション アフィニティを無効にし、[Azure Cache for Redis](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-overview) や [Azure SQL Database](https://learn.microsoft.com/ja-jp/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql) などの外部のデータベースにセッション情報を保持する必要があります。
これにはアプリケーション側の変更が必要になりますが、各開発言語のフレームワークによってはセッション情報を外部のデータベースに保持するためのライブラリが提供されている場合があります。

たとえば ASP.NET Core では、[Microsoft.Extensions.Caching.SqlServer](https://www.nuget.org/packages/Microsoft.Extensions.Caching.SqlServer) パッケージを使用することで、SQL Server にセッション情報を保持することができます。


外部のセッションストアとして Azure Cache for Redis を使用する方法については以下のドキュメントが用意されていますので利用する開発言語に応じてご参照ください。

* [**ASP.NET Web アプリで Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-web-app-howto)

* [**ASP.NET Core Web アプリで Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-web-app-aspnet-core-howto)

* [**Node.js で Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-nodejs-get-started)

* [**Java で Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-java-get-started)

* [**Python で Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-python-get-started)

* [**Go で Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-go-get-started)

* [**Rust で Azure Cache for Redis を使用する**](https://learn.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-rust-get-started)

その他、Web サイト/アプリケーションで WebSocket や SignalR といったリアルタイム メッセージング プロトコルを使用する場合は別のアプローチが必要になります。

通常の Web アプリケーションはポートの 80/443 を使用して介して HTTP/HTTPS の通信を行い、その際ソケットを開き通信が終了すれば閉じられますが、WebSocket や SignalR は長距離(Long range) ハンドルを保持するため長期間実行されており開いたままとなります。

つまりこれらリアルタイム メッセージング プロトコルでは、クライアントとサーバーを固定する必要があるため HTTP/HTTPS と同様の負荷分散方式を使用することができません。

このような場合、使用している リアルタイム メッセージング プロトコルが WebSocket の場合は [**Azure Web PubSub Service**](https://learn.microsoft.com/ja-jp/azure/azure-web-pubsub/overview) を、 SignalR を使用している場合は [**Azure SignalR Service**](https://learn.microsoft.com/ja-jp/azure/azure-signalr/signalr-overview) の使用を検討してください。

これらサービスの詳細についてはそれぞれ以下のドキュメントを参照してください。

 * [**Azure Web PubSub サービスとは**](https://learn.microsoft.com/ja-jp/azure/azure-web-pubsub/overview) 
 * [**Azure SignalR サービスとは**](https://learn.microsoft.com/ja-jp/azure/azure-signalr/signalr-overview)


<br>


## タスク 3 : 高度なログ監視

演習 2 の [タスク 2 : App Service ログの設定と有効化](ex02.md#%E3%82%BF%E3%82%B9%E3%82%AF-2--app-service-%E3%83%AD%E3%82%B0%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E6%9C%89%E5%8A%B9%E5%8C%96) では、一般的な Web サーバーで取得可能なログを Azure App Service で取得する手順について紹介しましたが、Azure App Service では Azure に用意されている監視ソリューションである [Azure Monitor](https://learn.microsoft.com/ja-jp/azure/azure-monitor/overview) の機能を使用してさらに詳細なアプリケーションの実行状況を監視するためのログを取得することができます。

このタスクでは、[メトリック](https://learn.microsoft.com/ja-jp/azure/app-service/web-sites-monitor#understand-metrics)を使用した状態の監視と [Log Analytics](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview) を使用して Azure Monitor が取得したログをクエリーし、必要な情報を取得する方法、また、[Application Insights](https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/app-insights-overview) の[自動インストルメンテーション](https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/codeless-overview)のアプリケーション監視の機能について確認します。

**■ Azure の監視ソリューションについて**

この演習で使用する メトリック、Log Analytics、Application Insights はいずれも Azure Monitor の機能です。Azure Monitor はクラウド環境、オンプレミス環境問わず監視データを収集し、分析し、それに対応するための包括的な監視ソリューションであり、Azure におけるアプリケーションを監視するサービスの基盤となっています。Azure Monitor は、アプリケーションのパフォーマンスを把握し、アプリケーションに影響を与える問題と、アプリケーションが依存するリソースを事前に特定するのに役立ちます。

その他の監視ソリューションとして [**Azure Service Health**](https://learn.microsoft.com/ja-jp/azure/service-health/overview) があります。
Azure Service Health は、停止や計画メンテナンスなどの Azure サービスの問題が影響を受けた場合に、常に情報を入手し、アクションを実行するのに役立ちます。つまり、ホストしているアプリケーションではなく、Azure サービスそのものに対しての監視を行うことができます。


この 2 つの監視サービスの役割と違いについての詳細は以下のドキュメントをご参照ください。

* [**What’s the difference between Azure Monitor and Azure Service Health?**](https://azure.microsoft.com/en-us/blog/what-s-the-difference-between-azure-monitor-and-azure-service-health/)

**■ メトリックとログについて**

Azure Monitor の**メトリック**と**ログ**は、システムの監視に使用される 2 つの主要なデータタイプですが、それぞれ異なる目的と特性を持っています。

**メトリック**は、数値で表されるパフォーマンスデータ（例えば、CPU使用率やメモリ使用量など）を時系列データベースに収集する機能で、一定の間隔で収集されます。これらのデータは、システムの特定の時点での状態を示し、グラフを表示して確認することができます⁵。

一方、**ログ**は、システム内で発生するあらゆるイベントを記録したもので、詳細な説明のテキストが付加されます。ログは、特定のイベントや問題についてより詳細な情報を提供し、複雑な分析に適しています。また、ログは定期的には収集されず、データの構造もメトリックとは異なります。

したがって、メトリックはシステムの全体的なパフォーマンスを把握するために使用され、ログは特定の問題やイベントを詳細に分析するために使用されます。また、メトリックとログはそれぞれ異なるデータソースから収集され、異なる方法で分析されます。

Azure Monitor が提供するメトリックとログについての詳細はそれぞれ以下のドキュメントをご参照ください。

* [**Azure Monitor のメトリックの概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics)

* [**Azure Monitor のログの概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-platform-logs)

<br>

### タスク 3.1 : メトリック アラートの設定

メトリックはパフォーマンスデータを数値化して監視できますが、メトリックの値が特定の閾値を超えた場合にアラートを発行することもできます。

また HTTP のステータスも監視できるので、これを使用してエラーが発生した際にアラートを発行することもできます。

この演習では HTTP500 エラーが発生した際にアラートを発行する設定を行います。

なお、この演習では [**タスク 1.2 : GitHub リポジトリを使用した CI/CD**](#%E3%82%BF%E3%82%B9%E3%82%AF-12--github-%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F-cicd) の演習でスワップしたステージング スロット **MovieApp-XYZ/staging** を使用します。これは、このスロットに修正したプロジェクトをデプロイする前の、HTTP500 エラーを発生させるコード含むプロジェクトがスワップされて残っているためです。

具体的な手順は以下のとおりです。

1. Azure ポータルで App Servive **MovieApp-XYZ/staging** を選択し、\[**概要**\] 画面の \[**既定の URL**\] をクリックし、アプリケーションの画面が正常に表示されるのを確認します

2. Web ブラウザーのアドレスバー以下の URL 入力し、SPA の画面を表示します

    ```
    https://<App Service の名前>.azurewebsites.net/index.html
    ```
    アプリケーションのタイトルが Movies SPA に変わっていることを確認します

    この SPA で使用している編集 API は HTTP500 エラーを返すようになっているのでこれを使用してエラーを発生させ、アプリケーション ログにエラー情報を取得します

3. リストされている映画のタイトルから、このタスクで追加した映画の \[**Edit**\] リンクをクリックし、遷移した編集画面で \[**Update**\] ボタンをクリックします

    HTTP500 エラーが返ることを確認、メトリックやログで分かりやすいように、この操作を複数回行ってください

    <img src="images/SPA_Error_http500.png" width="500px">

4. 画面左のメニューから項目 \[**監視**\] の下にある \[**メトリック**\]を選択し、遷移した画面で検出条件の各ドロップダウン ボックスを以下のように設定します

    |項目|値|
    |---|---|
    |スコープ| `MovieApp-XYZ` |
    |メトリック名前空間| `スロット 標準的なメトリック` |
    |メトリック| `HTTP Server Errors` |

    <img src="images/AppService_Metric.png" width="800px"> 

    設定と同時に前の手順にで発生された HTTP500 エラーの合計数グラフに表示されることを確認します。また各グラフのスパイク位置をクリックすると、その回数が表示されます。

    <img src="images/AppService_Metric_httpError_Summary.png" width="700px">

5. HTTP Server Error 発生時にアラート メッセージが送信されるように設定します。
    グラフ上部の \[**新しいアラートルール**\] をクリックします

6. \[**アラート ルールの作成**\] 画面に遷移するので、\[**条件**\] タブの各項目を以下のように設定します

    |項目|値|
    |---|---|
    |シグナル名 \*| \[**Http Server Errors**\] |

    **アラート ロジック**

    |項目|値|
    |---|---|
    |しきい値| \[**Static**\] |
    |集計の種類| \[**最大値**\] |
    |演算子| \[**次の値より大きい**\] |
    |単位| \[**カウント**\] |
    |しきい値 \*| `3` | 

    **ディメンジョンで分割する**

    (既定のまま)

    **評価するタイミング**

    |項目|値|
    |---|---|
    |確認する間隔| \[**1 分**\] (※)|
    |ルックバック期間| \[**5 分**\] |

    (※) 演習では早めに結果を確認したいため最小時間に設定してあります。

    設定が完了したら画面下にある \[]**次へ: アクション**\] ボタンをクリックします
 
    <img src="images/AppService_Create_AleatRule.png" width="700px">

7. \[**アクション**\] タブに遷移するので、\[**+ アクション グループの作成**\] をクリックし、さらに遷移した \[**基本**\] タブの各設定を以下のようにします

    **プロジェクトの詳細**

    |項目|値|
    |---|---|
    |サブスクリプション \*| 現在お使いのサブスクリプション |
    |リソース グループ \*| \[**PaaS_Handson**\] |
    |リージョン| \[**(US) East US2**\] |

    **インスタンスの詳細**

    |項目|値|
    |---|---|
    |アクション グループ名 \*| `Alert_HttpServer_Error` |
    |表示名 \*| `WebServerErr` |

    設定が完了したら画面下にある \[**次へ : 通知 \>**\] ボタンをクリックします

    <img src="images/Alert_Create_ActionGroup.png" width="700px">

8. \[**通知**\] タブに遷移するので、\[**通知タイプ**\] ドロップダウンボックスをクリックし \[**電子メール/SMS メッセージ/プッシュ/音声**\] を選択します

    画面右に \[**電子メール/SMS メッセージ/プッシュ/音声**\] ブレードが表示されるので、チェック ボックス\[**電子メール**\] にチェックを付け、\[**電子メール**\] に受信が確認可能な任意のメールアドレスを入力し、他の項目は既定のままで \[**OK**\] ボタンをクリックします。

    \[**通知**\] タブの画面に戻るので、\[**名前**\] ボックスに `HttpServerErrorNotice` と入力し、\[**確認と作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

    <img src="images/ActionGroup_create_notice.png" width="1000px">

    なお、今回は設定しませんが、ここで \[**次へ: アクション \>**\] ボタンをクリックすると、Azure Function や Webhook、イベントハブ、ロジックアプリなどのアクションを設定することができます。

9. \[**詳細**\] タブに遷移するので、同画面の各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|値|
    |---|---|
    |サブスクリプション \*| 現在お使いのサブスクリプション |
    |リソース グループ \*| \[**PaaS_Handson**\] |

    **アラート ルールの詳細**

    |項目|値|
    |---|---|
    |重大度 \*| \[**3 - 情報**\] |
    |アラート ルール名 \*| `HttpServerError_Notice` |
    |アラート ルールの説明| `アプリケーションのサーバーサイドでエラーが発生した際に通知します` |

    <img src="images/Alert_Create_Detail.png" width="700px">

    設定が完了したら \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします

    アラートルールの作成が完了するまで待ちます

10. アラートルールの作成が完了したら、App Servive **MovieApp-XYZ/staging** の以下の URL にアクセスして SPA 画面を表示します

    ```
    https://<App Service の名前>.azurewebsites.net/index.html
    ```

    映画リストの \[**Edit**\] リンクをクリックし、遷移した編集画面で \[**Update**\] ボタンを 3 回以上クリックして HTTP500 エラーを発生させます。

    しばらくすると、アラート ルールの \[**通知**\] タブで設定したメールアドレスにアラートメールが届きますので内容を確認してください。

    <img src="images/Alert_email.png" width="500px">

ここまでの手順でアラートメッセージの設定作業は完了です。

この演習では Azure Monitor のメトリックの機能を使用して App Service でホストするアプリケーションのサーバーサイドのエラー (HTTP500.x)を監視し、エラーが発生した際にメールを送信するアラート ルールを作成しました。

メトリックでは HTTP のステータス以外でも CPU 使用率やメモリ使用量などのパフォーマンスデータ、そのた監視対象が提供するさまざまなデータを監視することができます。

たとえば事前に障害が発生する兆候と回避方法を把握している場合にはメトリックで検知し、**アクション**から Webhook や Function でそれを回避するためのアクションを実行することもできます。

同様にもし、障害が発生した場合でも、修復方法がわかっている場合は障害を検知し**アクション**を使用して自動回復する仕組みを用意しておくこともできます。


その他、この演習ではメトリックを異常検知のトリガーとしてしか使用しませんでしたが、App Service の \[**メトリック**\] メニューを選択した際に表示されるメトリック エクスプローラーでは複数のデータソースを組み合わせたり、グラフの種類を変更したりすることで、より詳細な監視を行うことができます。

詳細については以下のドキュメントをご参照ください。　

* [**Azure Monitor メトリックス エクスプローラーを使用してメトリックを分析する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics)

App Service で使用できるメトリックについては以下のドキュメントをご参照ください。

* [**Azure App Service のアプリの監視 - メトリックを理解する**](https://learn.microsoft.com/ja-jp/azure/app-service/web-sites-monitor#understand-metrics)

<br>

### タスク 3.2 : Log Analytics を使用したログの分析

Azure の監視の基盤である Azure Monitor が収集したログを分析するための機能として [Log Analytics](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview) があります。
Log Analytics を使用して Azure Monitor が収集したログ データを並べ替え、フィルターし、分析します。 

また、より高度なクエリを作成して統計分析を実行し、結果をグラフで視覚化して特定の傾向を識別することもできます。

クエリの結果を対話的に操作する場合でも、ログ クエリ アラートやブックなどの他の Azure Monitor の機能で使用する場合でも、クエリ結果の書き込みとテストのためのツールとして Log Analytics を使用することができます。

この演習では App Service でホストされているアプリケーションに対して Log Analytics が使用できるように構成し、アプリケーションのログをクエリーしてエラーの発生状況を確認します。

大まかな手順としては、まず最初に Log Analytics ワークスペースを作成し、次に App Service でホストされているアプリケーションに対して Log Analytics を有効にします。そして、アプリケーションのログをクエリーしてエラーの発生状況を確認します。

<br>

#### タスク 3.2.1 : Log Analytics ワークスペースの作成

App Service で Log Analytics を使用するための Log Analytics ワークスペースを作成します。

なお、この演習でも前の演習と同じく HTTP500 エラーを確認に使用するので、前の演習で使用した App Service **MovieApp-XYZ/staging** を対象とします。

具体的な手順は以下のとおりです。

1. Azure ポータルのホーム画面にある検索ボックスに \[**Log Analytics**\] と入力し、検索結果の \[**Log Analytics ワークスペース**\] をクリックします

    <img src="images/LogAnalytics_Search.png" width="500px">

2. \[**Log Analytics ワークスペース**\] 画面に遷移するので、画面上部にある \[**+ 作成**\] ボタンをクリックします

    <img src="images/LogAnalytics_Create.png" width="400px">

3. \[**Log Analytics ワークスペースの作成**\] 画面に遷移し \[**基本**\] タブが表示されるので、同タブの各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|値|
    |---|---|
    |サブスクリプション \*| 現在お使いのサブスクリプション |
    |リソース グループ \*| \[**PaaS_Handson**\] |

    **インスタンスの詳細**


    |項目|値|
    |---|---|
    |名前 \*| `PaaSHandson-LogAnalytics` |
    |地域 \*| \[**Japan East**\] |

    <img src="images/LogAnalytics_Create_Detail.png" width="700px">

    設定が完了したら画面下にある \[**確認および作成**\] ボタンをクリックし、[**作成**] ボタンが表示されたらクリックしてデプロイを開始します。

4. デプロイが完了したら、Azure ポータルの[ホーム画面](https://portal.azure.com/#home) から App Service `MovieApp-XYZ/staging` アイコンをクリックし、画面左のメニューの \[**監視**\] グループにある \[**診断設定**\] をクリックします

    \[**診断設定**\] 画面に遷移するので、画面内の \[**+ 診断設定を追加する**\] をクリックします

    <img src="images/AppService_Create_DiagSetting.png" width="700px">

5. 診断設定の追加の作成画面に遷移するので、同画面の各項目を以下のように設定します

    * **診断設定の名前 \***

        `PaaSHandson-DiagSetting`

    * **ログ** と **メトリック**

        すべてのチェックボックスにチェック

    * **宛先の詳細**

    |項目|値|
    |---|---|
    |Log Analytics ワークスペースへの送信| チェック |
    |サブスクリプション| お使いのサブスクリプション |
    |Log Analytics ワークスペース| \[**PaaSHandson-LogAnalytics (japaneast)**\] (※)|
    |ストレージ アカウントへのアーカイブ| 既定のまま |
    |イベント ハブへのストリーム| 既定のまま |
    |パートナー ソリューションに送信| 既定のまま |

    (※) 前の手順で作成した Log Analytics ワークスペースを選択します。

    設定が完了したら画面上部にある \[**保存**\] ボタンをクリックします。

    <img src="images/AppService_New_DiagSetting.png" width="700px">

6. 保存が完了したら、Azure ポータルの[ホーム画面](https://portal.azure.com/#home) から App Service `MovieApp-XYZ/staging` アイコンをクリックし、画面左のメニューの \[**監視**\] グループにある \[**ログ**\] をクリックします

    \[**クエリ**\] というダイアログボックスが表示される場合は \[**閉じる**\] ボタンをクリックして閉じます。

    \[**ログ**\] 画面の \[**新しいクエリ 1**\] タブが表示されるので、同タブ内の \[**テーブル**\] タブのツリービュー \[**その他**\] に `AppServiceAppLogs` と `AppServiceHTTPLogs` が表示されていることを確認します。

    もし表示されていない場合は、画面上部の \[**スコープの選択**\] ボタンをクリックし、表示された Azure リソースの一覧から `MovieApp-XYZ/staging` を選択し \[**適用**\] ボタンをクリックします。

    <img src="images/Azure_log_table.png" width="400px">

7. \[**テーブル**\] タブのツリービュー \[**その他**\] に表示されている `AppServiceHTTPLogs` をダブルクリックし、画面右のクエリー エディターに文字列 `AppServiceHTTPLogs`が入力されたことを確認し、画面上部の \[**実行**\] ボタンをクリックします。

    クエリーが実行され、HTTP リクエストの一覧が表示されるので、任意のリクエストをクリックすると、そのリクエストの詳細が表示されるので確認します。

    <img src="images/AppService_log_queryAllResult.png" width="1000px">

6. リクエストを HTTP500 エラーでフィルターします。

    クエリーエディターの内容を以下のように書き換え、画面上部の \[**実行**\] ボタンをクリックします。

    ```
    AppServiceHTTPLogs |
    where ScStatus == 500 
    ```
    クエリーが実行され、HTTP500 エラーのリクエストの一覧が表示されるので、任意のリクエストをクリックして **ScStatus** の内容が **500** であることを確認します。

7. HTTP500 (HTTP Server Error) をフィルターするクエリーを保存します

    画面上部の \[**保存**\] - \[**クエリとして保存**\] をクリックすると、画面の右側に \[**クエリとして保存**\] ブレードが表示されるので、同ブレードの各項目を以下のように設定します。

    |項目|値|
    |---|---|
    |クエリ名 \*| `HTTPServerError` |
    |説明 | `HTTP500 のリクエストのみをリストします` |
    |既定のクエリ パックに保存する | チェック |
    |リソースの種類 | \[**App Services**\] |
    |カテゴリ | \[**Applications**\] |
    |ラベル | \[**新しいラベルを作成**\] をクリックして `MyQuery` というラベルを作成して指定|
    
    設定が完了したら画面下にある \[**保存**\] ボタンをクリックします。

    <img src="images/AppService_log_querySave.png" width="300px">

8. クエリーエディタの画面に戻るので \[**クエリ**\] タブをアクティブにし、検索ボックスに `HTTPServerError` と入力してキーボードの \[Enter\] キーを押下ます

    前の手順で作成したクエリー \[**HTTPServerError**\] が検索結果に表示され、使用できることを確認します。

    <img src="images/AppService_log_queryFind.png" width="800px">

これでいつでも作成したクエリーを呼び出して Log Analytics で App Service のログをクエリーすることができるようになりました。

ここまでの手順で App Serrvice から Log Analytics を利用可能とする設定は完了です。

演習では、Log Analytics を使用してアプリケーションのエラーを検索しましたが、
さらに複雑なクエリーを Kusto 照会言語 (KQL) で記述して、ログの検索や集計や分析等も可能です。
ログ クエリの詳しい使い方については以下のドキュメントをご参照ください。

* [**Azure Monitor でログ クエリの使用を開始する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/get-started-queries)

また、今回の演習では触れませんでしたが、[タスク 3.1 の演習](#%E3%82%BF%E3%82%B9%E3%82%AF-31--%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A)で使用した**メトリック**と同様にアラート ルールを作成して、ログの内容に応じたさまざまなアクションを構成することもできます。具体的な手順については以下のドキュメントをご参照ください。

* [**チュートリアル:Azure リソースのログ クエリ アラートを作成する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/tutorial-log-alert)

Log Analytics 全体の使用方法についての詳細は以下のドキュメントをご参照ください。

* [**Azure Monitor の Log Analytics の概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview)

<br>

### タスク 3.3 : Application Insights を使用したアプリケーションの監視

Application Insights は、アプリケーションのパフォーマンスや利用状況を監視するためのサービスです。Application Insights を使用すると App Service に限らず、さまざまなホスト環境で動作しているアプリケーションの情報を取得することができます。

このタスクでは、App Service でホストされているアプリケーションに対して Application Insights を有効にし、アプリケーションの状態を確認します。

エラーを発生させるために、前の演習で使用した App Service **MovieApp-XYZ/staging** を使用します。

具体的な手順は以下のとおりです。

1. Azure ポータルで App Servive **MovieApp-XYZ/staging** を選択し、画面に左のメニューより \[**Application Insights**\] をクリックします。

    はじめてアクセスした場合は遷移先の画面に \[**Application Insights を有効にする**\] ボタンが表示されるのでクリックします。

    <img src="images/AppInsights_Enable_Button.png" width="700px">

    トグルボタンが表示されている場合も同様に \[**有効にする**\] をクリックします。

    <img src="images/AppInsights_Enable_toggle.png" width="500px">

2. 表示されている画面の \[**アプリケーションのインストルメンテーション**\] で \[**.NET Core**\] タブをアクティブにし(※)、の各項目を以下のように設定します。

    (※) これは演習用アプリケーションが .NET7 で作成されているためです。実際の運用環境で使用する場合にはホストしているアプリケーションが使用している言語に合わせて設定してください。

    |項目|値|
    |---|---|
    |コレクション レベル| \[**推奨**\] |
    |Application Insights SDK との相互運用| \[**オフ**\] |
    |Profiler| \[**オン**\] |
    |スナップショット デバッガー| \[**オン**\] |
    |例外がスローされたときに、アプリケーションのローカル変数を表示します。| \[**オン**\] |
    |SQL コマンド| \[**オン**\] |

    <img src="images/AppInsights_Instrumentation.png">

    設定が完了したら画面下にある \[**適用**\] ボタンをクリックします。

3. Application Insights にエラーを検出させるために演習用アプリケーションを操作して HTTP500 エラーを発生させます。

    画面左のメニューから項目 \[**概要**\] を選択し、\[**既定の URL**\] をクリックし、アプリケーションの画面が正常に表示されるのを確認します

    Web ブラウザーのアドレスバー以下の URL 入力し、SPA の画面を表示します

    ```
    https://<App Service の名前>.azurewebsites.net/index.html
    ```

    アプリケーションのタイトルが Movies SPA に変わっていることを確認し、映画リストの \[**Edit**\] リンクをクリックし、遷移した編集画面で \[**Update**\] ボタンを 3 回以上クリックして HTTP500 エラーを発生させます。

4. Application Insights で取得された情報を確認します。

    Azure ポータルの[ホーム画面](https://portal.azure.com/#home)からリソースグループ [**PaaS_Handson**\] を開き、`MovieApp-XYZ` という Application Insights が作成されていることを確認し、同アイコンをクリックします。

5. \[**概要**\] 画面が表示されるので、同画面のグラフ \[**失敗した要求**\]、\[**サーバー要求**\] にリクエストが検出されていることを確認します

    <img src="images/AppInsights_Datail_Graph.png" width="700px">

6. 画面左の \[**アプリケーション マップ**\] をクリックすると、クライアント、SQL データベース、アプリケーションの図が表示されるので、`MovieApp-XYZ-staging` をクリックするか、マウスをホバーした際に表示さるメニューから \[**詳細を表示**\] をクリックします。

    <img src="images/AppInsights_ApplicationMap.png" width="700px">

    画面右に表示されるブレードにエラーやパフォーマンスの情報が表示されているのを確認します。

    <img src="images/AppInsights_Map_Blade.png" width="500px">

    なお、このブレードに表示されている \[**エラーの調査**\]、\[**パフォーマンスの調査**\] というボタンは、それぞれ画面左のメニューの \[**障害**\]、\[**パフォーマンス**\] にリンクされています。この 2 つについてはこの後の手順で説明するのでクリックしなくて大丈夫です。

7. 画面左のメニューの \[**障害**\] をクリックすると、アプリケーションで発生したエラーについての情報が表示されます。

    画面の右側に \[**全般**\] エラーとして上から順に `500`、`SqlException`,`SQL` と並んでいますが、今回のエラーの場合、どのボックスをクリックしても最終的に同じエラー情報にたどり着くので、一番原因に近いと思われる `SQL` をクリックし、さらに表示されたブレードの \[**提案**\] ボックスをクリックします。

    <img src="images/AppInsights_Failures.png" width="1000px">

    \[**エンド ツー エンド トランザクション**\] の画面が表示され、\[**イベント**\] リストに 3 つの要素が表示されているので、それぞれをクリックして画面右に表示されるブレードでエラーの詳細を確認します。

    <img src="images/AppInsights_Failures_Detail.png" width="1000px">

    エラーの内容に HTTP500 エラーが発生した際の HTTP メソッド、URL、スタックトレース、SQL クエリーなどが表示されているのを確認ししてください。

8. 画面左のメニューの \[**パフォーマンス**\] をクリックすると、アプリケーションのパフォーマンスについての情報が表示されます。

    この場面にはアプリケーションを構成するファイル等に対するリクエスト受信からからレスポンスまでの時間が表示されているので、パフォーマンスのボトルネックを調査する場合に有効です。

    <img src="images/AppInsights_Performance.png" width="1000px">

ここまでの手順で App Serrvice から Application Insights を利用可能とする設定は完了です。

演習では、Application Insights を使用してアプリケーションのエラーを検索しましたが、これは Application Insights の機能のほんの一部に過ぎません。

Application Insights はアプリケーションのパフォーマンスに関する問題の診断するための[**プロファイラー**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/profiler/profiler-overview)や、効率的なアプリケーションを開発するための[コード最適化](https://learn.microsoft.com/ja-jp/azure/azure-monitor/insights/code-optimizations)、Web アプリケーションの潜在的なパフォーマンスの問題や失敗の異常に関する警告を通知する [スマート検出](https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/proactive-diagnostics)、他にもさまざまな機能を提供しています。

Application Insights についての詳細は以下のドキュメントをご参照ください。

* [**Application Insights の概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/app-insights-overview)


<br>

## まとめ

この演習では、Web アプリケーションやコンテンツをホストする際に、一般的な Web サーバーの管理で行う設定や管理作業を Azure App Service で行う方法について学習しました。

より詳しい内容については、各タスクの最後に記載したドキュメントを参照してください。


<br>

---
👉 : [**演習 4) Advanced なネットワーク設定**](ex04.md)へ

👈 : [**演習 2) Web サイトを運用するための基本的な設定**](ex02.md)へ

🏚️ :  [**README**](README.md)



